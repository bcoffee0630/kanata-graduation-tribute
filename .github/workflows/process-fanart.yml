name: Process Fan Art Submission

on:
  issues:
    types: [labeled]

jobs:
  process-fanart:
    if: contains(github.event.issue.labels.*.name, 'approved') && contains(github.event.issue.labels.*.name, 'fanart')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Process fan art submission
        id: process
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const https = require('https');
            const path = require('path');
            const issue = context.payload.issue;
            const body = issue.body;

            function parseField(body, fieldName) {
              const regex = new RegExp(`### ${fieldName}[\\s\\S]*?\\n\\n([\\s\\S]*?)(?=\\n###|$)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            const artist = parseField(body, 'Artist Name');
            const artistLink = parseField(body, 'Artist Link');
            const artworkField = parseField(body, 'Upload Artwork');
            const captionJa = parseField(body, 'Caption \\(Japanese\\)');
            const captionZh = parseField(body, 'Caption \\(Traditional Chinese\\)');
            const captionEn = parseField(body, 'Caption \\(English\\)');

            // Validate required fields
            if (!artist || !artworkField) {
              core.setFailed('Missing required fields');
              return;
            }

            // Extract image URL from markdown
            const imageMatch = artworkField.match(/!\[.*?\]\((https:\/\/[^\)]+)\)/);
            if (!imageMatch) {
              core.setFailed('No image found in submission');
              return;
            }
            const imageUrl = imageMatch[1];

            // Determine file extension from URL
            let ext = 'png';
            if (imageUrl.toLowerCase().includes('.jpg') || imageUrl.toLowerCase().includes('.jpeg')) {
              ext = 'jpg';
            } else if (imageUrl.toLowerCase().includes('.png')) {
              ext = 'png';
            }

            const filename = `fanart-${issue.number}.${ext}`;
            const imagePath = `memories/fanart/images/${filename}`;

            // Ensure directory exists
            const dir = path.dirname(imagePath);
            if (!fs.existsSync(dir)) {
              fs.mkdirSync(dir, { recursive: true });
            }

            // Download image
            const downloadImage = (url, filepath) => {
              return new Promise((resolve, reject) => {
                const file = fs.createWriteStream(filepath);
                const request = (url) => {
                  https.get(url, (response) => {
                    // Handle redirects
                    if (response.statusCode >= 300 && response.statusCode < 400 && response.headers.location) {
                      request(response.headers.location);
                      return;
                    }
                    if (response.statusCode !== 200) {
                      reject(new Error(`Failed to download: ${response.statusCode}`));
                      return;
                    }
                    response.pipe(file);
                    file.on('finish', () => {
                      file.close();
                      resolve();
                    });
                  }).on('error', reject);
                };
                request(url);
              });
            };

            await downloadImage(imageUrl, imagePath);

            // Verify file was downloaded
            if (!fs.existsSync(imagePath)) {
              core.setFailed('Failed to download image');
              return;
            }

            // Update index.json
            const indexPath = 'memories/fanart/index.json';
            const data = JSON.parse(fs.readFileSync(indexPath, 'utf8'));

            const existingIds = data.fanart.map(f => parseInt(f.id));
            const newId = String(Math.max(...existingIds, 0) + 1).padStart(3, '0');

            const newEntry = {
              id: newId,
              filename: filename,
              path: `images/${filename}`,
              artist: artist,
              date: new Date().toISOString().split('T')[0],
              isOfficial: false,
              caption: {}
            };

            // Add artist link if provided
            if (artistLink && artistLink !== '_No response_') {
              newEntry.artistLink = artistLink;
            }

            // Add captions
            if (captionJa && captionJa !== '_No response_') {
              newEntry.caption.ja = captionJa;
            }
            if (captionZh && captionZh !== '_No response_') {
              newEntry.caption['zh-TW'] = captionZh;
            }
            if (captionEn && captionEn !== '_No response_') {
              newEntry.caption.en = captionEn;
            }

            // Default caption if none provided
            if (Object.keys(newEntry.caption).length === 0) {
              newEntry.caption = {
                ja: `${artist}さんの作品`,
                'zh-TW': `${artist} 的作品`,
                en: `Artwork by ${artist}`
              };
            }

            data.fanart.push(newEntry);
            fs.writeFileSync(indexPath, JSON.stringify(data, null, 2) + '\n');

            core.exportVariable('ARTIST_NAME', artist);
            core.exportVariable('ISSUE_NUMBER', issue.number);
            core.exportVariable('NEW_ID', newId);

            console.log(`Added fan art ${newId} from ${artist}`);

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add fan art from ${{ env.ARTIST_NAME }} (#${{ env.ISSUE_NUMBER }})"
          title: "Add fan art: ${{ env.ARTIST_NAME }}"
          body: |
            ## New Fan Art Submission

            This PR adds new fan art from **${{ env.ARTIST_NAME }}**.

            - Fan Art ID: `${{ env.NEW_ID }}`
            - Source: Issue #${{ env.ISSUE_NUMBER }}

            ---

            Closes #${{ env.ISSUE_NUMBER }}

            ---
            *Auto-generated from issue submission.*
          branch: submission/fanart-${{ env.ISSUE_NUMBER }}
          labels: automated,fanart
          delete-branch: true
